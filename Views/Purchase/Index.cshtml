<div class="container">
    <h1>Cart</h1>
    <div class="table">
    <table >
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>total</th>
                <th>Change Quantity</th>
            </tr>
        </thead>
        <tbody id="cartItems">
        </tbody>
    </table>
  </div>
  <div class="inline-block">
    <button class="btn btn-primary" onclick="checkout()">Checkout</button>
    <h3> Total Cost: <span id="totalCost">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></h3>
  </div>
</div>
<script>
  load()
  function checkout(){
    fetch('/Purchase/Checkout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body:localStorage.getItem('cart')
    }).then(
      (response) =>
      {
      if(response.status !== 200){
        response.json().then((x) => alert(x.message))
      }
      else{
        console.log(response)
        response.json().then((x) =>
          alert(x.message + ' Total cost mesured in EGP: ' + x.totalCost))
        localStorage.removeItem('cart')
        window.location.href = '/Home'
      }
      }
    )
  }
  function load(){
    if (localStorage.getItem('cart') === "[]"){
      const tbody = document.getElementById('cartItems')
      tbody.innerHTML = ''
      return ;
    }
    fetch('/Purchase', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body:localStorage.getItem('cart')
    }).then(
      (response) =>
      {
      if(response.status !== 200){
        response.json().then((x) => alert(x.message))
      }
      else{
        response.json()
          .then((x) => {
          const tbody = document.getElementById('cartItems')
          let totalCost = 0
          tbody.innerHTML = ''
          x.forEach(item => {
            const tr = document.createElement('tr')
            const td1 = document.createElement('td')
            td1.textContent = item.name
            const td2 = document.createElement('td')
            td2.textContent =item.quantity
            const td3 = document.createElement('td')
            td3.textContent = item.price
            const td4 = document.createElement('td')
            td4.textContent = item.price * item.quantity
            const td5 = document.createElement('td')
            td5.innerHTML = `<button class="btn btn-success" onclick="increaseQuantity(${item.id})"> + </button>
              <button class="btn btn-danger" onclick="decreaseQuantity(${item.id})"> - </button>`
            tr.appendChild(td1)
            tr.appendChild(td2)
            tr.appendChild(td3)
            tr.appendChild(td4)
            tr.appendChild(td5)
            tbody.appendChild(tr)
            totalCost += item.price * item.quantity
          })
          document.getElementById('totalCost').textContent = totalCost;
        })
      }
      }
    )
  }
  function increaseQuantity(id){
    const cart = JSON.parse(localStorage.getItem('cart')) ?? []
    cart.forEach(item => {
      if(item.id === id){
        item.quantity++
      }
    })
    localStorage.setItem('cart', JSON.stringify(cart))
    load()
  }
  function decreaseQuantity(id){
    const cart = JSON.parse(localStorage.getItem('cart')) ?? []
    cart.forEach(item => {
      if(item.id === id){
        item.quantity--
      }
      if (item.quantity === 0){
        cart.splice(cart.indexOf(item), 1)
      }
    })
    localStorage.setItem('cart', JSON.stringify(cart))
    load()
  }
</script>

